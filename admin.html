<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Bella Pizza</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</head>
<body>
<header>
    <div class="header-content">
        <a href="index.html"><img src="logo.png" alt="Bella Pizza Logo" class="logo"></a>
    </div>
</header>
<main>
    <section id="login-section">
        <h2>Login do Administrador</h2>
        <form id="login-form">
            <div class="form-group">
                <label class="group-label" for="username">Usuário</label>
                <input id="username" type="text" required>
            </div>
            <div class="form-group">
                <label class="group-label" for="password">Senha</label>
                <input id="password" type="password" required>
            </div>
            <button type="submit" class="btn-primary">Entrar</button>
        </form>
        <div id="login-error" style="color:#c0392b;margin-top:8px;display:none;">Credenciais inválidas</div>
    </section>
    <section id="dashboard-section" style="display:none;">
        <div class="dashboard-header">
            <h2>Área Administrativa</h2>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button id="tab-pricing" class="btn-secondary">Gerenciar Preços</button>
                <button id="tab-orders" class="btn-secondary">Registros de Pedidos</button>
                <a href="index.html" class="btn-secondary">Voltar ao Site</a>
                <button id="logout" class="btn-danger">Sair</button>
            </div>
        </div>
        <section id="pricing-section" style="display:none;">
            <h3 class="menu-subtitle">Preços das Pizzas</h3>
            <div class="form-group">
                <label class="group-label" for="new-flavor">Novo sabor</label>
                <input id="new-flavor" type="text" placeholder="Ex.: Calabresa 3">
                <button id="add-flavor" class="btn-secondary" type="button">Adicionar sabor</button>
            </div>
            <div class="table-wrap"><div id="pricing-table"></div></div>
            <div class="modal-actions">
                <button id="save-pricing" class="btn-primary">Salvar preços</button>
                <span id="pricing-feedback" style="margin-left:10px;color:#0f0;display:none;">Salvo</span>
            </div>
        </section>
        <section id="orders-section" style="display:none;">
            <h3 class="menu-subtitle">Pedidos do Mês</h3>
            <div class="form-group">
                <label class="group-label" for="month">Mês</label>
                <input id="month" type="month">
                <div style="margin-top:8px;">
                    <label style="display:inline-flex;align-items:center;gap:8px;">
                        <input id="all-months" type="checkbox">
                        <span>Todos os meses</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="group-label" for="mode-filter">Modo</label>
                <select id="mode-filter">
                    <option value="">Todos</option>
                    <option value="delivery">Entrega</option>
                    <option value="pickup">Retirada</option>
                </select>
                <label class="group-label" for="status-filter" style="margin-top:8px;">Status</label>
                <select id="status-filter">
                    <option value="">Todos</option>
                    <option value="pending">Pendente</option>
                    <option value="completed">Concluído</option>
                    <option value="canceled">Cancelado</option>
                </select>
                <button id="export-csv" class="btn-secondary" type="button">Exportar CSV</button>
            </div>
            <div id="stats" class="order-summary"></div>
            <div id="revenue-chart" class="table-wrap"></div>
            <div class="table-wrap"><div id="orders-table"></div></div>
            <div id="order-details"></div>
        </section>
    </section>
</main>
<footer>
    <p>&copy; 2026 Bella Pizza. Área administrativa.</p>
</footer>
<script>
let SQLModule=null;let db=null;
function toB64(u){let s='';for(let i=0;i<u.length;i++)s+=String.fromCharCode(u[i]);return btoa(s);}
function fromB64(s){const b=atob(s);const u=new Uint8Array(b.length);for(let i=0;i<b.length;i++)u[i]=b.charCodeAt(i);return u;}
async function initDb(){if(SQLModule&&db)return;SQLModule=await initSqlJs({locateFile:function(f){return 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/'+f;}});const saved=localStorage.getItem('bella2_db');db=saved?new SQLModule.Database(fromB64(saved)):new SQLModule.Database();db.exec("CREATE TABLE IF NOT EXISTS admin(username TEXT PRIMARY KEY,salt TEXT,hash TEXT)");db.exec("CREATE TABLE IF NOT EXISTS orders(id TEXT PRIMARY KEY,created_at TEXT,phone TEXT,mode TEXT,total REAL,payload TEXT)");db.exec("CREATE TABLE IF NOT EXISTS pricing(flavor TEXT PRIMARY KEY,price_p REAL,price_g REAL)");db.exec("CREATE TABLE IF NOT EXISTS flavors(flavor TEXT PRIMARY KEY,category TEXT,description TEXT,active INTEGER)");const rs=db.exec("SELECT username FROM admin LIMIT 1");if(!rs.length){const salt=String(Math.random()).slice(2)+String(Math.random()).slice(2);const enc=new TextEncoder();const digest=await crypto.subtle.digest('SHA-256',enc.encode(salt+'mudinho'));const v=new Uint8Array(digest);let hex='';for(let i=0;i<v.length;i++)hex+=v[i].toString(16).padStart(2,'0');const stmt=db.prepare("INSERT INTO admin(username,salt,hash) VALUES(?,?,?)");stmt.run(['mudinho',salt,hex]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));}}
async function hashPass(salt,p){const enc=new TextEncoder();const d=await crypto.subtle.digest('SHA-256',enc.encode(salt+p));const v=new Uint8Array(d);let h='';for(let i=0;i<v.length;i++)h+=v[i].toString(16).padStart(2,'0');return h;}
async function me(){const s=localStorage.getItem('admin_session');if(!s)return null;return {username:s};}
async function login(username,password){await initDb();const stmt=db.prepare("SELECT username,salt,hash FROM admin WHERE username=?");stmt.bind([username]);let ok=false;if(stmt.step()){const row=stmt.getAsObject();const h=await hashPass(row.salt,password);ok=h===row.hash;}stmt.free();if(ok){localStorage.setItem('admin_session',username);}return ok;}
async function logout(){localStorage.removeItem('admin_session');}
async function loadOrders(month){await initDb();const stmt=db.prepare("SELECT id,created_at,phone,mode,total,payload FROM orders");const items=[];while(stmt.step()){const row=stmt.getAsObject();items.push({id:row.id,created_at:row.created_at,phone:row.phone,mode:row.mode,total:row.total});}stmt.free();const out=month?items.filter(o=>typeof o.created_at==='string'&&o.created_at.slice(0,7)===month):items.slice().reverse();return {items:out};}
let ordersPayloadMap={};
async function loadOrdersWithPayload(month,mode){await initDb();const stmt=db.prepare("SELECT id,created_at,phone,mode,total,payload FROM orders");const items=[];ordersPayloadMap={};while(stmt.step()){const row=stmt.getAsObject();ordersPayloadMap[row.id]=row.payload||'';items.push({id:row.id,created_at:row.created_at,phone:row.phone,mode:row.mode,total:row.total,payload:row.payload||''});}stmt.free();let out=items.slice().reverse();if(month)out=out.filter(o=>typeof o.created_at==='string'&&o.created_at.slice(0,7)===month);if(mode)out=out.filter(o=>o.mode===mode);return {items:out};}
async function loadPricing(){await initDb();const stmt=db.prepare("SELECT p.flavor, p.price_p, p.price_g, COALESCE(f.category,'salgada') AS category, COALESCE(f.description,'') AS description, COALESCE(f.active,1) AS active FROM pricing p LEFT JOIN flavors f ON f.flavor=p.flavor ORDER BY p.flavor");const rows=[];while(stmt.step()){rows.push(stmt.getAsObject());}stmt.free();return rows;}
function fmtBRL(n){return 'R$ '+Number(n||0).toFixed(2).replace('.',',');}
function renderTable(items){let html='<div class="order-summary">';html+='<div class="order-line">Total de pedidos: '+items.length+'</div>';const sum=items.reduce((acc,o)=>acc+Number(o.total||0),0);html+='<div class="order-line">Faturamento do mês: '+fmtBRL(sum)+'</div>';html+='</div>';html+='<table style="width:100%;border-collapse:collapse;">';html+='<thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Data</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Telefone</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Tipo</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Total</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Ações</th></tr></thead>';html+='<tbody>';for(let i=0;i<items.length;i++){const o=items[i];const d=new Date(o.created_at);const ds=d.toLocaleString('pt-BR');const mode=o.mode==='delivery'?'Entrega':'Retirada';html+='<tr>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+ds+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+(o.phone||'')+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+mode+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+fmtBRL(o.total||0)+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><button class="btn-secondary btn-details" data-id="'+o.id+'">Detalhes</button></td>';html+='</tr>';}html+='</tbody></table>';document.getElementById('stats').innerHTML='';document.getElementById('orders-table').innerHTML=html;const btns=document.querySelectorAll('.btn-details');for(let j=0;j<btns.length;j++){btns[j].addEventListener('click',function(e){const id=e.currentTarget.getAttribute('data-id');const payload=ordersPayloadMap[id]||'';let out='';try{out=JSON.stringify(JSON.parse(payload||'{}'),null,2);}catch{out=String(payload||'');}document.getElementById('order-details').innerHTML='<pre style=\"background:#222;color:#eee;padding:10px;border-radius:8px;overflow:auto;\">'+out+'</pre>';});}}
function renderPricingEditor(rows){let html='<table style="width:100%;border-collapse:collapse;">';html+='<thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Sabor</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Descrição</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Categoria</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Ativo</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Preço P</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Preço G</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Ações</th></tr></thead><tbody>';for(let i=0;i<rows.length;i++){const r=rows[i];html+='<tr>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+r.flavor+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><input type="text" class="desc" data-flavor="'+r.flavor+'" value="'+String(r.description||'').replace(/\"/g,'&quot;')+'"></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><select class="cat" data-flavor="'+r.flavor+'"><option value="salgada"'+(r.category==='salgada'?' selected':'')+'>Salgada</option><option value="doce"'+(r.category==='doce'?' selected':'')+'>Doce</option></select></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><input type="checkbox" class="act" data-flavor="'+r.flavor+'" '+(Number(r.active)?'checked':'')+'></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><input type="number" step="0.01" min="0" class="price-p" data-flavor="'+r.flavor+'" value="'+Number(r.price_p||0)+'"></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><input type="number" step="0.01" min="0" class="price-g" data-flavor="'+r.flavor+'" value="'+Number(r.price_g||0)+'"></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><button class="btn-danger btn-remove-flavor" data-flavor="'+r.flavor+'">Remover</button></td>';html+='</tr>';}html+='</tbody></table>';document.getElementById('pricing-table').innerHTML=html;const rbtns=document.querySelectorAll('.btn-remove-flavor');for(let k=0;k<rbtns.length;k++){rbtns[k].addEventListener('click',async function(e){const fl=e.currentTarget.getAttribute('data-flavor');await initDb();let stmt=db.prepare("DELETE FROM pricing WHERE flavor=?");stmt.run([fl]);stmt.free();stmt=db.prepare("DELETE FROM flavors WHERE flavor=?");stmt.run([fl]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));const rows2=await loadPricing();renderPricingEditor(rows2);});}}
async function savePricing(){const pInputs=document.querySelectorAll('#pricing-table .price-p');const gInputs=document.querySelectorAll('#pricing-table .price-g');const dInputs=document.querySelectorAll('#pricing-table .desc');const cInputs=document.querySelectorAll('#pricing-table .cat');const aInputs=document.querySelectorAll('#pricing-table .act');await initDb();let stmt=db.prepare("INSERT OR REPLACE INTO pricing(flavor,price_p,price_g) VALUES(?,?,?)");for(let i=0;i<pInputs.length;i++){const flavor=pInputs[i].getAttribute('data-flavor');const pVal=parseFloat(pInputs[i].value)||0;const gVal=parseFloat(gInputs[i].value)||0;stmt.run([flavor,pVal,gVal]);}stmt.free();stmt=db.prepare("INSERT OR REPLACE INTO flavors(flavor,category,description,active) VALUES(?,?,?,?)");for(let i=0;i<dInputs.length;i++){const flavor=dInputs[i].getAttribute('data-flavor');const desc=dInputs[i].value||'';const cat=cInputs[i].value||'salgada';const act=aInputs[i].checked?1:0;stmt.run([flavor,cat,desc,act]);}stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));const fb=document.getElementById('pricing-feedback');if(fb){fb.style.display='';setTimeout(function(){fb.style.display='none';},1500);}}
async function addFlavor(){const inp=document.getElementById('new-flavor');const name=(inp.value||'').trim();if(!name)return;await initDb();let stmt=db.prepare("INSERT OR IGNORE INTO pricing(flavor,price_p,price_g) VALUES(?,?,?)");stmt.run([name,0,0]);stmt.free();stmt=db.prepare("INSERT OR IGNORE INTO flavors(flavor,category,description,active) VALUES(?,?,?,?)");stmt.run([name,'salgada','',1]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));inp.value='';const rows=await loadPricing();renderPricingEditor(rows);}
function exportCsv(items){let csv='Data,Telefone,Modo,Total\\n';for(let i=0;i<items.length;i++){const o=items[i];const d=new Date(o.created_at).toISOString();const line=[d,(o.phone||'').replace(/,/g,' '),o.mode,Number(o.total||0)].join(',');csv+=line+'\\n';}const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='pedidos.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
document.addEventListener('DOMContentLoaded', async function(){await initDb();const m=await me();if(m&&m.username){document.getElementById('login-section').style.display='none';document.getElementById('dashboard-section').style.display='';}const monthEl=document.getElementById('month');const modeEl=document.getElementById('mode-filter');const now=new Date();const monthStr=now.toISOString().slice(0,7);if(monthEl)monthEl.value=monthStr;async function refresh(){const mm=(monthEl&&monthEl.value)||monthStr;const md=(modeEl&&modeEl.value)||'';const data=await loadOrdersWithPayload(mm,md);renderTable(data.items||[]);}const btnPricing=document.getElementById('tab-pricing');const btnOrders=document.getElementById('tab-orders');function showPricing(){document.getElementById('pricing-section').style.display='';document.getElementById('orders-section').style.display='none';}function showOrders(){document.getElementById('orders-section').style.display='';document.getElementById('pricing-section').style.display='none';}btnPricing.addEventListener('click',async function(){const rows=await loadPricing();renderPricingEditor(rows);showPricing();});btnOrders.addEventListener('click',async function(){await refresh();showOrders();});if(monthEl)monthEl.addEventListener('change',refresh);if(modeEl)modeEl.addEventListener('change',refresh);await refresh();document.getElementById('save-pricing').addEventListener('click',async function(){await savePricing();});document.getElementById('add-flavor').addEventListener('click',async function(){await addFlavor();});document.getElementById('export-csv').addEventListener('click',async function(){const mm=(monthEl&&monthEl.value)||monthStr;const md=(modeEl&&modeEl.value)||'';const data=await loadOrdersWithPayload(mm,md);exportCsv(data.items||[]);});const form=document.getElementById('login-form');form.addEventListener('submit',async function(e){e.preventDefault();const u=document.getElementById('username').value.trim();const p=document.getElementById('password').value;const ok=await login(u,p);if(!ok){const err=document.getElementById('login-error');err.style.display='';return;}document.getElementById('login-error').style.display='none';document.getElementById('login-section').style.display='none';document.getElementById('dashboard-section').style.display='';await refresh();});document.getElementById('logout').addEventListener('click',async function(){await logout();document.getElementById('dashboard-section').style.display='none';document.getElementById('login-section').style.display='';});});
</script>
<script>
let __adminEnhanceApplied=false;
async function __adminEnsureDb(){if(typeof initDb==='function'){await initDb();}}
function __hasColumn(cols,name){for(let i=0;i<cols.length;i++){if(String(cols[i][1]||'')===name)return true;}return false;}
async function ensureOrderStatusColumns(){await __adminEnsureDb();const info=db.exec("PRAGMA table_info(orders)");let cols=[];if(info.length&&info[0]&&info[0].values)cols=info[0].values;if(!__hasColumn(cols,'status')){db.exec("ALTER TABLE orders ADD COLUMN status TEXT");}const info2=db.exec("PRAGMA table_info(orders)");let cols2=[];if(info2.length&&info2[0]&&info2[0].values)cols2=info2[0].values;if(!__hasColumn(cols2,'settled_at')){db.exec("ALTER TABLE orders ADD COLUMN settled_at TEXT");}localStorage.setItem('bella2_db',toB64(db.export()));}
async function loadOrdersWithPayload(month,mode,status){await ensureOrderStatusColumns();const stmt=db.prepare("SELECT id,created_at,phone,mode,total,payload,COALESCE(status,'pending') AS status,COALESCE(settled_at,'') AS settled_at FROM orders");const items=[];ordersPayloadMap={};while(stmt.step()){const row=stmt.getAsObject();ordersPayloadMap[row.id]=row.payload||'';items.push({id:row.id,created_at:row.created_at,phone:row.phone,mode:row.mode,total:row.total,payload:row.payload||'',status:row.status,settled_at:row.settled_at});}stmt.free();let out=items.slice().reverse();if(month)out=out.filter(o=>typeof o.created_at==='string'&&o.created_at.slice(0,7)===month);if(mode)out=out.filter(o=>o.mode===mode);if(status)out=out.filter(o=>o.status===status);return {items:out};}
function renderTable(items){let completed=0;let pending=0;let canceled=0;let sumCompleted=0;for(let i=0;i<items.length;i++){if(items[i].status==='completed'){completed+=1;sumCompleted+=Number(items[i].total||0);}else if(items[i].status==='canceled'){canceled+=1;}else{pending+=1;}}let summary='<div class="order-summary">';summary+='<div class="order-line">Total de pedidos: '+items.length+'</div>';summary+='<div class="order-line">Concluídos: '+completed+' — '+fmtBRL(sumCompleted)+'</div>';summary+='<div class="order-line">Pendentes: '+pending+'</div>';summary+='<div class="order-line">Cancelados: '+canceled+'</div>';summary+='</div>';document.getElementById('stats').innerHTML=summary;let html='<table style="width:100%;border-collapse:collapse;">';html+='<thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Data</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Telefone</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Tipo</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Total</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Status</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Ações</th></tr></thead>';html+='<tbody>';for(let i=0;i<items.length;i++){const o=items[i];const d=new Date(o.created_at);const ds=d.toLocaleString('pt-BR');const mode=o.mode==='delivery'?'Entrega':'Retirada';const st=o.status||'pending';const stLabel=st==='completed'?'Concluído':(st==='canceled'?'Cancelado':'Pendente');html+='<tr>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+ds+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+(o.phone||'')+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+mode+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+fmtBRL(o.total||0)+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+stLabel+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><button class="btn-secondary btn-details" data-id="'+o.id+'">Detalhes</button> ';html+='<button class="btn-primary btn-complete" data-id="'+o.id+'" '+(st==='completed'?'disabled':'')+'>Concluir</button> ';html+='<button class="btn-danger btn-cancel" data-id="'+o.id+'" '+(st==='canceled'?'disabled':'')+'>Cancelar</button></td>';html+='</tr>';}html+='</tbody></table>';document.getElementById('orders-table').innerHTML=html;const btns=document.querySelectorAll('.btn-details');for(let j=0;j<btns.length;j++){btns[j].addEventListener('click',function(e){const id=e.currentTarget.getAttribute('data-id');const payload=ordersPayloadMap[id]||'';let out='';try{out=JSON.stringify(JSON.parse(payload||'{}'),null,2);}catch{out=String(payload||'');}document.getElementById('order-details').innerHTML='<pre style="background:#222;color:#eee;padding:12px;border-radius:8px;overflow:auto">'+out+'</pre>';});}const btnc=document.querySelectorAll('.btn-complete');for(let k=0;k<btnc.length;k++){btnc[k].addEventListener('click',async function(e){const id=e.currentTarget.getAttribute('data-id');await markOrderCompleted(id);});}const btnx=document.querySelectorAll('.btn-cancel');for(let m=0;m<btnx.length;m++){btnx[m].addEventListener('click',async function(e){const id=e.currentTarget.getAttribute('data-id');await markOrderCanceled(id);});}}
async function markOrderCompleted(id){await ensureOrderStatusColumns();const now=new Date().toISOString();const stmt=db.prepare("UPDATE orders SET status=?, settled_at=? WHERE id=?");stmt.run(['completed',now,id]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));const mm=document.getElementById('all-months').checked?'':document.getElementById('month').value;const md=document.getElementById('mode-filter').value||'';const data=await loadOrdersWithPayload(mm,md);renderTable(data.items||[]);}
async function markOrderCanceled(id){await ensureOrderStatusColumns();const stmt=db.prepare("UPDATE orders SET status=?, settled_at=NULL WHERE id=?");stmt.run(['canceled',id]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));const mm=document.getElementById('all-months').checked?'':document.getElementById('month').value;const md=document.getElementById('mode-filter').value||'';const data=await loadOrdersWithPayload(mm,md);renderTable(data.items||[]);}
function renderRevenueChartBars(monthTotals){const container=document.getElementById('revenue-chart');if(!container)return;const months=Object.keys(monthTotals).sort();if(months.length===0){container.innerHTML='';return;}const max=Math.max.apply(null,months.map(m=>monthTotals[m]||0));let bars='<div style="display:flex;gap:8px;align-items:flex-end;height:180px;padding:10px 0;">';for(let i=0;i<months.length;i++){const m=months[i];const val=monthTotals[m]||0;const h=max>0?Math.round((val/max)*160):0;bars+='<div title="'+m+' '+fmtBRL(val)+'" style="width:28px;background:#ffc107;border:1px solid #333;height:'+h+'px"></div>'; }bars+='</div>';let labels='<div style="display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap;">';for(let i=0;i<months.length;i++){labels+='<div style="width:28px;text-align:center;font-size:12px;color:#ccc">'+months[i]+'</div>';}labels+='</div>';container.innerHTML='<h4 style="margin:6px 0;color:#ffc107">Faturamento mensal (concluídos)</h4>'+bars+labels;}
async function renderRevenueChartAll(){const data=await loadOrdersWithPayload('', '', 'completed');const items=data.items||[];const totals={};for(let i=0;i<items.length;i++){const o=items[i];const base=o.settled_at||o.created_at||'';const key=typeof base==='string'?base.slice(0,7):'';if(!key)continue;totals[key]=(totals[key]||0)+Number(o.total||0);}renderRevenueChartBars(totals);}
document.addEventListener('DOMContentLoaded',async function(){if(__adminEnhanceApplied)return;__adminEnhanceApplied=true;const monthEl=document.getElementById('month');const modeEl=document.getElementById('mode-filter');const statusEl=document.getElementById('status-filter');const allMonthsEl=document.getElementById('all-months');async function refreshEnhanced(){const mm=(allMonthsEl&&allMonthsEl.checked)?'':((monthEl&&monthEl.value)||'');const md=(modeEl&&modeEl.value)||'';const st=(statusEl&&statusEl.value)||'';const data=await loadOrdersWithPayload(mm,md,st);renderTable(data.items||[]);await renderRevenueChartAll();}if(allMonthsEl)allMonthsEl.addEventListener('change',refreshEnhanced);if(monthEl)monthEl.addEventListener('change',refreshEnhanced);if(modeEl)modeEl.addEventListener('change',refreshEnhanced);if(statusEl)statusEl.addEventListener('change',refreshEnhanced);await ensureOrderStatusColumns();await refreshEnhanced();});
</script>
</body>
</html>
