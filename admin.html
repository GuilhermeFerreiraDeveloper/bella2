<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Bella Pizza</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</head>
<body>
<header>
    <div class="header-content">
        <img src="logo.png" alt="Bella Pizza Logo" class="logo">
    </div>
</header>
<main>
    <section id="login-section">
        <h2>Login do Administrador</h2>
        <form id="login-form">
            <div class="form-group">
                <label class="group-label" for="username">Usuário</label>
                <input id="username" type="text" required>
            </div>
            <div class="form-group">
                <label class="group-label" for="password">Senha</label>
                <input id="password" type="password" required>
            </div>
            <button type="submit" class="btn-primary">Entrar</button>
        </form>
        <div id="login-error" style="color:#c0392b;margin-top:8px;display:none;">Credenciais inválidas</div>
    </section>
    <section id="dashboard-section" style="display:none;">
        <div class="dashboard-header">
            <h2>Pedidos do Mês</h2>
            <div class="form-group">
                <label class="group-label" for="month">Mês</label>
                <input id="month" type="month">
            </div>
            <button id="logout" class="btn-danger">Sair</button>
        </div>
        <div id="stats" class="order-summary"></div>
        <div id="orders-table"></div>
    </section>
</main>
<footer>
    <p>&copy; 2026 Bella Pizza. Área administrativa.</p>
</footer>
<script>
let SQLModule=null;let db=null;
function toB64(u){let s='';for(let i=0;i<u.length;i++)s+=String.fromCharCode(u[i]);return btoa(s);}
function fromB64(s){const b=atob(s);const u=new Uint8Array(b.length);for(let i=0;i<b.length;i++)u[i]=b.charCodeAt(i);return u;}
async function initDb(){if(SQLModule&&db)return;SQLModule=await initSqlJs({locateFile:function(f){return 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/'+f;}});const saved=localStorage.getItem('bella2_db');db=saved?new SQLModule.Database(fromB64(saved)):new SQLModule.Database();db.exec("CREATE TABLE IF NOT EXISTS admin(username TEXT PRIMARY KEY,salt TEXT,hash TEXT)");db.exec("CREATE TABLE IF NOT EXISTS orders(id TEXT PRIMARY KEY,created_at TEXT,phone TEXT,mode TEXT,total REAL,payload TEXT)");const rs=db.exec("SELECT username FROM admin LIMIT 1");if(!rs.length){const salt=String(Math.random()).slice(2)+String(Math.random()).slice(2);const enc=new TextEncoder();const digest=await crypto.subtle.digest('SHA-256',enc.encode(salt+'mudinho'));const v=new Uint8Array(digest);let hex='';for(let i=0;i<v.length;i++)hex+=v[i].toString(16).padStart(2,'0');const stmt=db.prepare("INSERT INTO admin(username,salt,hash) VALUES(?,?,?)");stmt.run(['mudinho',salt,hex]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));}}
async function hashPass(salt,p){const enc=new TextEncoder();const d=await crypto.subtle.digest('SHA-256',enc.encode(salt+p));const v=new Uint8Array(d);let h='';for(let i=0;i<v.length;i++)h+=v[i].toString(16).padStart(2,'0');return h;}
async function me(){const s=localStorage.getItem('admin_session');if(!s)return null;return {username:s};}
async function login(username,password){await initDb();const stmt=db.prepare("SELECT username,salt,hash FROM admin WHERE username=?");stmt.bind([username]);let ok=false;if(stmt.step()){const row=stmt.getAsObject();const h=await hashPass(row.salt,password);ok=h===row.hash;}stmt.free();if(ok){localStorage.setItem('admin_session',username);}return ok;}
async function logout(){localStorage.removeItem('admin_session');}
async function loadOrders(month){await initDb();const stmt=db.prepare("SELECT id,created_at,phone,mode,total,payload FROM orders");const items=[];while(stmt.step()){const row=stmt.getAsObject();items.push({id:row.id,created_at:row.created_at,phone:row.phone,mode:row.mode,total:row.total});}stmt.free();const out=month?items.filter(o=>typeof o.created_at==='string'&&o.created_at.slice(0,7)===month):items.slice().reverse();return {items:out};}
function fmtBRL(n){return 'R$ '+Number(n||0).toFixed(2).replace('.',',');}
function renderTable(items){let html='<div class="order-summary">';html+='<div class="order-line">Total de pedidos: '+items.length+'</div>';const sum=items.reduce((acc,o)=>acc+Number(o.total||0),0);html+='<div class="order-line">Faturamento do mês: '+fmtBRL(sum)+'</div>';html+='</div>';html+='<table style="width:100%;border-collapse:collapse;">';html+='<thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Data</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Telefone</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Tipo</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Total</th></tr></thead>';html+='<tbody>';for(let i=0;i<items.length;i++){const o=items[i];const d=new Date(o.created_at);const ds=d.toLocaleString('pt-BR');const mode=o.mode==='delivery'?'Entrega':'Retirada';html+='<tr>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+ds+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+(o.phone||'')+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+mode+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+fmtBRL(o.total||0)+'</td>';html+='</tr>';}html+='</tbody></table>';document.getElementById('stats').innerHTML='';document.getElementById('orders-table').innerHTML=html;}
document.addEventListener('DOMContentLoaded', async function(){await initDb();const m=await me();if(m&&m.username){document.getElementById('login-section').style.display='none';document.getElementById('dashboard-section').style.display='';}const monthEl=document.getElementById('month');const now=new Date();const monthStr=now.toISOString().slice(0,7);monthEl.value=monthStr;async function refresh(){const mm=monthEl.value||monthStr;const data=await loadOrders(mm);renderTable(data.items||[]);}monthEl.addEventListener('change',refresh);await refresh();const form=document.getElementById('login-form');form.addEventListener('submit',async function(e){e.preventDefault();const u=document.getElementById('username').value.trim();const p=document.getElementById('password').value;const ok=await login(u,p);if(!ok){const err=document.getElementById('login-error');err.style.display='';return;}document.getElementById('login-error').style.display='none';document.getElementById('login-section').style.display='none';document.getElementById('dashboard-section').style.display='';await refresh();});document.getElementById('logout').addEventListener('click',async function(){await logout();document.getElementById('dashboard-section').style.display='none';document.getElementById('login-section').style.display='';});});
</script>
</body>
</html>
