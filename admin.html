<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Bella Pizza</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</head>
<body>
<header>
    <div class="header-content">
        <a href="index.html"><img src="logo.png" alt="Bella Pizza Logo" class="logo"></a>
    </div>
</header>
<main>
    <section id="login-section">
        <h2>Login do Administrador</h2>
        <form id="login-form">
            <div class="form-group">
                <label class="group-label" for="username">Usuário</label>
                <input id="username" type="text" required>
            </div>
            <div class="form-group">
                <label class="group-label" for="password">Senha</label>
                <input id="password" type="password" required>
            </div>
            <button type="submit" class="btn-primary">Entrar</button>
        </form>
        <div id="login-error" style="color:#c0392b;margin-top:8px;display:none;">Credenciais inválidas</div>
    </section>
    <section id="dashboard-section" style="display:none;">
        <div class="dashboard-header">
            <h2>Área Administrativa</h2>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button id="tab-pricing" class="btn-secondary">Gerenciar Preços</button>
                <button id="tab-orders" class="btn-secondary">Registros de Pedidos</button>
                <a href="index.html" class="btn-secondary">Voltar ao Site</a>
                <button id="logout" class="btn-danger">Sair</button>
            </div>
        </div>
        <section id="pricing-section" style="display:none;">
            <h3 class="menu-subtitle">Preços das Pizzas</h3>
            <div class="form-group">
                <label class="group-label" for="new-flavor">Novo sabor</label>
                <input id="new-flavor" type="text" placeholder="Ex.: Calabresa 3">
                <button id="add-flavor" class="btn-secondary" type="button">Adicionar sabor</button>
            </div>
            <div class="table-wrap"><div id="pricing-table"></div></div>
            <div class="modal-actions">
                <button id="save-pricing" class="btn-primary">Salvar preços</button>
                <span id="pricing-feedback" style="margin-left:10px;color:#0f0;display:none;">Salvo</span>
            </div>
        </section>
        <section id="orders-section" style="display:none;">
            <h3 class="menu-subtitle">Pedidos do Mês</h3>
            <div class="form-group">
                <label class="group-label" for="month">Mês</label>
                <input id="month" type="month">
                <div style="margin-top:8px;">
                    <label style="display:inline-flex;align-items:center;gap:8px;">
                        <input id="all-months" type="checkbox">
                        <span>Todos os meses</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="group-label" for="mode-filter">Modo</label>
                <select id="mode-filter">
                    <option value="">Todos</option>
                    <option value="delivery">Entrega</option>
                    <option value="pickup">Retirada</option>
                </select>
                <label class="group-label" for="status-filter" style="margin-top:8px;">Status</label>
                <select id="status-filter">
                    <option value="">Todos</option>
                    <option value="pending">Pendente</option>
                    <option value="completed">Concluído</option>
                    <option value="canceled">Cancelado</option>
                </select>
                <button id="export-csv" class="btn-secondary" type="button">Exportar CSV</button>
            </div>
            <div class="form-group">
                <label class="group-label" for="search">Busca</label>
                <input id="search" type="text" placeholder="Telefone ou observação">
            </div>
            <div class="form-group">
                <label class="group-label" for="date-from">De</label>
                <input id="date-from" type="date">
                <label class="group-label" for="date-to" style="margin-left:8px;">Até</label>
                <input id="date-to" type="date">
            </div>
            <div class="form-group">
                <label class="group-label">Backup</label>
                <button id="backup-download" class="btn-secondary" type="button">Baixar Backup</button>
                <input id="backup-upload" type="file" accept=".txt" style="margin-left:8px;">
            </div>
            <div id="stats" class="order-summary"></div>
            <div id="revenue-chart" class="table-wrap"></div>
            <div class="table-wrap"><div id="orders-table"></div></div>
            <div id="order-details"></div>
        </section>
    </section>
</main>
<footer>
    <p>&copy; 2026 Bella Pizza. Área administrativa.</p>
</footer>
<script>
let SQLModule=null;let db=null;
function toB64(u){let s='';for(let i=0;i<u.length;i++)s+=String.fromCharCode(u[i]);return btoa(s);}
function fromB64(s){const b=atob(s);const u=new Uint8Array(b.length);for(let i=0;i<b.length;i++)u[i]=b.charCodeAt(i);return u;}
async function initDb(){if(SQLModule&&db)return;SQLModule=await initSqlJs({locateFile:function(f){return 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/'+f;}});const saved=localStorage.getItem('bella2_db');db=saved?new SQLModule.Database(fromB64(saved)):new SQLModule.Database();db.exec("CREATE TABLE IF NOT EXISTS admin(username TEXT PRIMARY KEY,salt TEXT,hash TEXT)");db.exec("CREATE TABLE IF NOT EXISTS orders(id TEXT PRIMARY KEY,created_at TEXT,phone TEXT,mode TEXT,total REAL,payload TEXT,status TEXT DEFAULT 'pending',settled_at TEXT,prepared_at TEXT)");db.exec("CREATE TABLE IF NOT EXISTS pricing(flavor TEXT PRIMARY KEY,price_p REAL,price_g REAL)");db.exec("CREATE TABLE IF NOT EXISTS flavors(flavor TEXT PRIMARY KEY,category TEXT,description TEXT,active INTEGER)");const rs=db.exec("SELECT username FROM admin LIMIT 1");if(!rs.length){const salt=String(Math.random()).slice(2)+String(Math.random()).slice(2);const enc=new TextEncoder();const digest=await crypto.subtle.digest('SHA-256',enc.encode(salt+'mudinho'));const v=new Uint8Array(digest);let hex='';for(let i=0;i<v.length;i++)hex+=v[i].toString(16).padStart(2,'0');const stmt=db.prepare("INSERT INTO admin(username,salt,hash) VALUES(?,?,?)");stmt.run(['mudinho',salt,hex]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));}}
async function hashPass(salt,p){const enc=new TextEncoder();const d=await crypto.subtle.digest('SHA-256',enc.encode(salt+p));const v=new Uint8Array(d);let h='';for(let i=0;i<v.length;i++)h+=v[i].toString(16).padStart(2,'0');return h;}
async function me(){const s=localStorage.getItem('admin_session');if(!s)return null;return {username:s};}
async function login(username,password){await initDb();const stmt=db.prepare("SELECT username,salt,hash FROM admin WHERE username=?");stmt.bind([username]);let ok=false;if(stmt.step()){const row=stmt.getAsObject();const h=await hashPass(row.salt,password);ok=h===row.hash;}stmt.free();if(ok){localStorage.setItem('admin_session',username);}return ok;}
async function logout(){localStorage.removeItem('admin_session');}
async function loadOrders(month){await initDb();const stmt=db.prepare("SELECT id,created_at,phone,mode,total,payload FROM orders");const items=[];while(stmt.step()){const row=stmt.getAsObject();items.push({id:row.id,created_at:row.created_at,phone:row.phone,mode:row.mode,total:row.total});}stmt.free();const out=month?items.filter(o=>typeof o.created_at==='string'&&o.created_at.slice(0,7)===month):items.slice().reverse();return {items:out};}
let ordersPayloadMap={};
async function loadOrdersWithPayload(month,mode){await initDb();const stmt=db.prepare("SELECT id,created_at,phone,mode,total,payload FROM orders");const items=[];ordersPayloadMap={};while(stmt.step()){const row=stmt.getAsObject();ordersPayloadMap[row.id]=row.payload||'';items.push({id:row.id,created_at:row.created_at,phone:row.phone,mode:row.mode,total:row.total,payload:row.payload||''});}stmt.free();let out=items.slice().reverse();if(month)out=out.filter(o=>typeof o.created_at==='string'&&o.created_at.slice(0,7)===month);if(mode)out=out.filter(o=>o.mode===mode);return {items:out};}
async function loadPricing(){await initDb();const stmt=db.prepare("SELECT p.flavor, p.price_p, p.price_g, COALESCE(f.category,'salgada') AS category, COALESCE(f.description,'') AS description, COALESCE(f.active,1) AS active FROM pricing p LEFT JOIN flavors f ON f.flavor=p.flavor ORDER BY p.flavor");const rows=[];while(stmt.step()){rows.push(stmt.getAsObject());}stmt.free();return rows;}
function fmtBRL(n){return 'R$ '+Number(n||0).toFixed(2).replace('.',',');}
function renderTable(items){let html='<div class="order-summary">';html+='<div class="order-line">Total de pedidos: '+items.length+'</div>';const sum=items.reduce((acc,o)=>acc+Number(o.total||0),0);html+='<div class="order-line">Faturamento do mês: '+fmtBRL(sum)+'</div>';html+='</div>';html+='<table style="width:100%;border-collapse:collapse;">';html+='<thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Data</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Telefone</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Tipo</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Total</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Ações</th></tr></thead>';html+='<tbody>';for(let i=0;i<items.length;i++){const o=items[i];const d=new Date(o.created_at);const ds=d.toLocaleString('pt-BR');const mode=o.mode==='delivery'?'Entrega':'Retirada';html+='<tr>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+ds+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+(o.phone||'')+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+mode+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+fmtBRL(o.total||0)+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><button class="btn-secondary btn-details" data-id="'+o.id+'">Detalhes</button></td>';html+='</tr>';}html+='</tbody></table>';document.getElementById('stats').innerHTML='';document.getElementById('orders-table').innerHTML=html;const btns=document.querySelectorAll('.btn-details');for(let j=0;j<btns.length;j++){btns[j].addEventListener('click',function(e){const id=e.currentTarget.getAttribute('data-id');const payload=ordersPayloadMap[id]||'';let out='';try{out=JSON.stringify(JSON.parse(payload||'{}'),null,2);}catch{out=String(payload||'');}document.getElementById('order-details').innerHTML='<pre style=\"background:#222;color:#eee;padding:10px;border-radius:8px;overflow:auto;\">'+out+'</pre>';});}}
function renderPricingEditor(rows){let html='<table style="width:100%;border-collapse:collapse;">';html+='<thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Sabor</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Descrição</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Categoria</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Ativo</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Preço P</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Preço G</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Ações</th></tr></thead><tbody>';for(let i=0;i<rows.length;i++){const r=rows[i];html+='<tr>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+r.flavor+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><input type="text" class="desc" data-flavor="'+r.flavor+'" value="'+String(r.description||'').replace(/\"/g,'&quot;')+'"></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><select class="cat" data-flavor="'+r.flavor+'"><option value="salgada"'+(r.category==='salgada'?' selected':'')+'>Salgada</option><option value="doce"'+(r.category==='doce'?' selected':'')+'>Doce</option></select></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><input type="checkbox" class="act" data-flavor="'+r.flavor+'" '+(Number(r.active)?'checked':'')+'></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><input type="number" step="0.01" min="0" class="price-p" data-flavor="'+r.flavor+'" value="'+Number(r.price_p||0)+'"></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><input type="number" step="0.01" min="0" class="price-g" data-flavor="'+r.flavor+'" value="'+Number(r.price_g||0)+'"></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><button class="btn-danger btn-remove-flavor" data-flavor="'+r.flavor+'">Remover</button></td>';html+='</tr>';}html+='</tbody></table>';document.getElementById('pricing-table').innerHTML=html;const rbtns=document.querySelectorAll('.btn-remove-flavor');for(let k=0;k<rbtns.length;k++){rbtns[k].addEventListener('click',async function(e){const fl=e.currentTarget.getAttribute('data-flavor');await initDb();let stmt=db.prepare("DELETE FROM pricing WHERE flavor=?");stmt.run([fl]);stmt.free();stmt=db.prepare("DELETE FROM flavors WHERE flavor=?");stmt.run([fl]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));const rows2=await loadPricing();renderPricingEditor(rows2);});}}
async function savePricing(){const pInputs=document.querySelectorAll('#pricing-table .price-p');const gInputs=document.querySelectorAll('#pricing-table .price-g');const dInputs=document.querySelectorAll('#pricing-table .desc');const cInputs=document.querySelectorAll('#pricing-table .cat');const aInputs=document.querySelectorAll('#pricing-table .act');await initDb();let stmt=db.prepare("INSERT OR REPLACE INTO pricing(flavor,price_p,price_g) VALUES(?,?,?)");for(let i=0;i<pInputs.length;i++){const flavor=pInputs[i].getAttribute('data-flavor');const pVal=parseFloat(pInputs[i].value)||0;const gVal=parseFloat(gInputs[i].value)||0;stmt.run([flavor,pVal,gVal]);}stmt.free();stmt=db.prepare("INSERT OR REPLACE INTO flavors(flavor,category,description,active) VALUES(?,?,?,?)");for(let i=0;i<dInputs.length;i++){const flavor=dInputs[i].getAttribute('data-flavor');const desc=dInputs[i].value||'';const cat=cInputs[i].value||'salgada';const act=aInputs[i].checked?1:0;stmt.run([flavor,cat,desc,act]);}stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));const fb=document.getElementById('pricing-feedback');if(fb){fb.style.display='';setTimeout(function(){fb.style.display='none';},1500);}}
async function addFlavor(){const inp=document.getElementById('new-flavor');const name=(inp.value||'').trim();if(!name)return;await initDb();let stmt=db.prepare("INSERT OR IGNORE INTO pricing(flavor,price_p,price_g) VALUES(?,?,?)");stmt.run([name,0,0]);stmt.free();stmt=db.prepare("INSERT OR IGNORE INTO flavors(flavor,category,description,active) VALUES(?,?,?,?)");stmt.run([name,'salgada','',1]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));inp.value='';const rows=await loadPricing();renderPricingEditor(rows);}
function exportCsv(items){let csv='Data,Telefone,Modo,Total\\n';for(let i=0;i<items.length;i++){const o=items[i];const d=new Date(o.created_at).toISOString();const line=[d,(o.phone||'').replace(/,/g,' '),o.mode,Number(o.total||0)].join(',');csv+=line+'\\n';}const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='pedidos.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
document.addEventListener('DOMContentLoaded', async function(){let m=null;try{await initDb();m=await me();}catch(e){m=null;}if(m&&m.username){document.getElementById('login-section').style.display='none';document.getElementById('dashboard-section').style.display='';}const monthEl=document.getElementById('month');const modeEl=document.getElementById('mode-filter');const now=new Date();const monthStr=now.toISOString().slice(0,7);if(monthEl)monthEl.value=monthStr;async function refresh(){const mm=(monthEl&&monthEl.value)||monthStr;const md=(modeEl&&modeEl.value)||'';const data=await loadOrdersWithPayload(mm,md);renderTable(data.items||[]);}const btnPricing=document.getElementById('tab-pricing');const btnOrders=document.getElementById('tab-orders');function showPricing(){document.getElementById('pricing-section').style.display='';document.getElementById('orders-section').style.display='none';}function showOrders(){document.getElementById('orders-section').style.display='';document.getElementById('pricing-section').style.display='none';}if(btnPricing)btnPricing.addEventListener('click',async function(){const rows=await loadPricing();renderPricingEditor(rows);showPricing();});if(btnOrders)btnOrders.addEventListener('click',async function(){const allMonthsEl=document.getElementById('all-months');const statusEl=document.getElementById('status-filter');const dfEl=document.getElementById('date-from');const dtEl=document.getElementById('date-to');const sEl=document.getElementById('search');if(typeof ensureOrderStatusColumns==='function')await ensureOrderStatusColumns();if(typeof loadOrdersWithPayload==='function'){const mm=(allMonthsEl&&allMonthsEl.checked)?'':((monthEl&&monthEl.value)||monthStr);const md=(modeEl&&modeEl.value)||'';const st=(statusEl&&statusEl.value)||'';const df=(dfEl&&dfEl.value)||'';const dt=(dtEl&&dtEl.value)||'';const q=(sEl&&sEl.value)||'';const data=await loadOrdersWithPayload(mm,md,st,df,dt,q);renderTable(data.items||[]);}else{await refresh();}showOrders();});if(monthEl)monthEl.addEventListener('change',refresh);if(modeEl)modeEl.addEventListener('change',refresh);try{await refresh();showOrders();}catch(e){}document.getElementById('save-pricing').addEventListener('click',async function(){await savePricing();});document.getElementById('add-flavor').addEventListener('click',async function(){await addFlavor();});document.getElementById('export-csv').addEventListener('click',async function(){const mm=(monthEl&&monthEl.value)||monthStr;const md=(modeEl&&modeEl.value)||'';const data=await loadOrdersWithPayload(mm,md);exportCsv(data.items||[]);});const form=document.getElementById('login-form');if(form)form.addEventListener('submit',async function(e){e.preventDefault();const u=document.getElementById('username').value.trim();const p=document.getElementById('password').value;const ok=await login(u,p);if(!ok){const err=document.getElementById('login-error');err.style.display='';return;}document.getElementById('login-error').style.display='none';document.getElementById('login-section').style.display='none';document.getElementById('dashboard-section').style.display='';showOrders();try{await refresh();}catch(e){}});const logoutBtn=document.getElementById('logout');if(logoutBtn)logoutBtn.addEventListener('click',async function(){await logout();document.getElementById('dashboard-section').style.display='none';document.getElementById('login-section').style.display='';});});
</script>
<script>
let __adminEnhanceApplied=false;
async function __adminEnsureDb(){if(typeof initDb==='function'){await initDb();}}
function __hasColumn(cols,name){for(let i=0;i<cols.length;i++){if(String(cols[i][1]||'')===name)return true;}return false;}
async function ensureOrderStatusColumns(){await __adminEnsureDb();let info;try{info=db.exec("PRAGMA table_info(orders)");}catch(e){return;}const cols=(info[0]&&info[0].values)||[];const hasStatus=__hasColumn(cols,'status');const hasSettled=__hasColumn(cols,'settled_at');const hasPrepared=__hasColumn(cols,'prepared_at');try{if(!hasStatus)db.exec("ALTER TABLE orders ADD COLUMN status TEXT DEFAULT 'pending'");if(!hasSettled)db.exec("ALTER TABLE orders ADD COLUMN settled_at TEXT");if(!hasPrepared)db.exec("ALTER TABLE orders ADD COLUMN prepared_at TEXT");localStorage.setItem('bella2_db',toB64(db.export()));}catch(e){}}
async function loadOrdersWithPayload(month,mode,status,dateFrom,dateTo,search){await __adminEnsureDb();await ensureOrderStatusColumns();let stmt;try{stmt=db.prepare("SELECT id,created_at,phone,mode,total,payload,status,settled_at,prepared_at FROM orders");}catch(e){return {items:[]};}ordersPayloadMap={};const items=[];while(stmt.step()){const row=stmt.getAsObject();const id=String(row.id||'');if(!id)continue;const payload=row.payload||'';ordersPayloadMap[id]=payload;items.push({id:id,created_at:row.created_at||'',phone:row.phone||'',mode:row.mode||'',total:row.total||0,payload:payload,status:row.status||'pending',settled_at:row.settled_at||'',prepared_at:row.prepared_at||''});}stmt.free();let out=items.slice();out.sort(function(a,b){const aa=String(a.created_at||'');const bb=String(b.created_at||'');return aa<bb?1:aa>bb?-1:0;});if(month)out=out.filter(function(o){return typeof o.created_at==='string'&&o.created_at.slice(0,7)===month;});if(dateFrom){const d0=new Date(dateFrom).getTime();out=out.filter(function(o){return new Date(o.created_at).getTime()>=d0;});}if(dateTo){const d1=new Date(dateTo).getTime();out=out.filter(function(o){return new Date(o.created_at).getTime()<=d1;});}if(mode)out=out.filter(function(o){return o.mode===mode;});if(status)out=out.filter(function(o){return o.status===status;});if(search){const q=String(search).toLowerCase();out=out.filter(function(o){return String(o.phone||'').toLowerCase().includes(q)||String(ordersPayloadMap[o.id]||'').toLowerCase().includes(q);});}return {items:out};}
function renderTable(items){let completed=0;let pending=0;let canceled=0;let sumCompleted=0;let sumAll=0;for(let i=0;i<items.length;i++){sumAll+=Number(items[i].total||0);if(items[i].status==='completed'){completed+=1;sumCompleted+=Number(items[i].total||0);}else if(items[i].status==='canceled'){canceled+=1;}else{pending+=1;}}const ticketMedio=completed>0?(sumCompleted/completed):0;let summary='<div class="order-summary">';summary+='<div class="order-line">Total de pedidos (filtrados): '+items.length+' — '+fmtBRL(sumAll)+'</div>';summary+='<div class="order-line">Concluídos: '+completed+' — '+fmtBRL(sumCompleted)+' — Ticket médio: '+fmtBRL(ticketMedio)+'</div>';summary+='<div class="order-line">Pendentes: '+pending+'</div>';summary+='<div class="order-line">Cancelados: '+canceled+'</div>';summary+='</div>';document.getElementById('stats').innerHTML=summary;let html='<table style="width:100%;border-collapse:collapse;">';html+='<thead><tr><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Data</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Telefone</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Tipo</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Total</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Status</th><th style="text-align:left;padding:8px;border-bottom:1px solid #ddd;">Ações</th></tr></thead>';html+='<tbody>';for(let i=0;i<items.length;i++){const o=items[i];const d=new Date(o.created_at);const ds=d.toLocaleString('pt-BR');const mode=o.mode==='delivery'?'Entrega':'Retirada';const st=o.status||'pending';const stIcon=st==='completed'?'✓':(st==='canceled'?'✕':(st==='prepared'?'⏳':'⏳'));const stClass=st==='completed'?'status-completed':(st==='canceled'?'status-canceled':(st==='prepared'?'status-prepared':'status-pending'));html+='<tr>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+ds+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><input type="tel" class="phone-edit" data-id="'+o.id+'" value="'+(o.phone||'')+'" style="width:160px"></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+mode+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;">'+fmtBRL(o.total||0)+'</td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><span class="status-badge '+stClass+'"><span>'+stIcon+'</span><span>'+st.toUpperCase()+'</span></span></td>';html+='<td style="padding:8px;border-bottom:1px solid #eee;"><button class="btn-secondary btn-details" data-id="'+o.id+'">Detalhes</button> ';html+='<button class="btn-secondary btn-whatsapp" data-id="'+o.id+'">WhatsApp</button> ';html+='<button class="btn-secondary btn-prepared" data-id="'+o.id+'" '+(st!=='pending'?'disabled':'')+'>Preparar</button> ';html+='<button class="btn-primary btn-complete" data-id="'+o.id+'" '+(st==='completed'?'disabled':'')+'>Concluir</button> ';html+='<button class="btn-danger btn-cancel" data-id="'+o.id+'" '+(st==='canceled'?'disabled':'')+'>Cancelar</button> ';html+='<button class="btn-danger btn-delete" data-id="'+o.id+'">Remover</button> ';html+='<button class="btn-secondary btn-save-phone" data-id="'+o.id+'">Salvar</button></td>';html+='</tr>';}html+='</tbody></table>';document.getElementById('orders-table').innerHTML=html;const btns=document.querySelectorAll('.btn-details');for(let j=0;j<btns.length;j++){btns[j].addEventListener('click',function(e){const id=e.currentTarget.getAttribute('data-id');const payload=ordersPayloadMap[id]||'';let obj={};try{obj=JSON.parse(payload||'{}');}catch{obj={};}const it=items.find(function(x){return x.id===id;})||{};const timeline=['Criado: '+(it.created_at||'')];if(it.prepared_at)timeline.push('Preparado: '+it.prepared_at);if(it.settled_at)timeline.push('Concluído: '+it.settled_at);let out='<div class="order-summary">'+timeline.map(function(t){return '<div class="order-line">'+t+'</div>';}).join('')+'</div>';out+='<pre style="background:#222;color:#eee;padding:12px;border-radius:8px;overflow:auto">'+JSON.stringify(obj,null,2)+'</pre>';out+='<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"><button class="btn-secondary" id="resend-'+id+'">Abrir WhatsApp</button></div>';document.getElementById('order-details').innerHTML=out;const btnRes=document.getElementById('resend-'+id);if(btnRes)btnRes.addEventListener('click',function(){resendWhatsApp(id);});});}const btnc=document.querySelectorAll('.btn-complete');for(let k=0;k<btnc.length;k++){btnc[k].addEventListener('click',async function(e){const id=e.currentTarget.getAttribute('data-id');await markOrderCompleted(id);});}const btnx=document.querySelectorAll('.btn-cancel');for(let m=0;m<btnx.length;m++){btnx[m].addEventListener('click',async function(e){const id=e.currentTarget.getAttribute('data-id');await markOrderCanceled(id);});}const btnp=document.querySelectorAll('.btn-prepared');for(let z=0;z<btnp.length;z++){btnp[z].addEventListener('click',async function(e){const id=e.currentTarget.getAttribute('data-id');await markOrderPrepared(id);});}const btnw=document.querySelectorAll('.btn-whatsapp');for(let q=0;q<btnw.length;q++){btnw[q].addEventListener('click',function(e){const id=e.currentTarget.getAttribute('data-id');resendWhatsApp(id);});}const btnDel=document.querySelectorAll('.btn-delete');for(let d=0;d<btnDel.length;d++){btnDel[d].addEventListener('click',async function(e){const id=e.currentTarget.getAttribute('data-id');await deleteOrder(id);});}const btnSave=document.querySelectorAll('.btn-save-phone');for(let s=0;s<btnSave.length;s++){btnSave[s].addEventListener('click',async function(e){const id=e.currentTarget.getAttribute('data-id');const inp=document.querySelector('.phone-edit[data-id="'+id+'"]');const val=inp?inp.value.trim():'';await savePhone(id,val);});}}
async function markOrderCompleted(id){try{await __adminEnsureDb();await ensureOrderStatusColumns();const now=new Date().toISOString();const stmt=db.prepare("UPDATE orders SET status=?,settled_at=? WHERE id=?");stmt.run(['completed',now,id]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));}catch(e){}const mm=(document.getElementById('all-months')&&document.getElementById('all-months').checked)?'':(document.getElementById('month')&&document.getElementById('month').value)||'';const md=(document.getElementById('mode-filter')&&document.getElementById('mode-filter').value)||'';const st=(document.getElementById('status-filter')&&document.getElementById('status-filter').value)||'';const df=(document.getElementById('date-from')&&document.getElementById('date-from').value)||'';const dt=(document.getElementById('date-to')&&document.getElementById('date-to').value)||'';const q=(document.getElementById('search')&&document.getElementById('search').value)||'';const data=await loadOrdersWithPayload(mm,md,st,df,dt,q);renderTable(data.items||[]);}
async function markOrderCanceled(id){try{await __adminEnsureDb();await ensureOrderStatusColumns();const stmt=db.prepare("UPDATE orders SET status=?,settled_at=? WHERE id=?");stmt.run(['canceled','',id]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));}catch(e){}const mm=(document.getElementById('all-months')&&document.getElementById('all-months').checked)?'':(document.getElementById('month')&&document.getElementById('month').value)||'';const md=(document.getElementById('mode-filter')&&document.getElementById('mode-filter').value)||'';const st=(document.getElementById('status-filter')&&document.getElementById('status-filter').value)||'';const df=(document.getElementById('date-from')&&document.getElementById('date-from').value)||'';const dt=(document.getElementById('date-to')&&document.getElementById('date-to').value)||'';const q=(document.getElementById('search')&&document.getElementById('search').value)||'';const data=await loadOrdersWithPayload(mm,md,st,df,dt,q);renderTable(data.items||[]);}
async function markOrderPrepared(id){try{await __adminEnsureDb();await ensureOrderStatusColumns();const now=new Date().toISOString();const stmt=db.prepare("UPDATE orders SET status=?,prepared_at=? WHERE id=?");stmt.run(['prepared',now,id]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));}catch(e){}const mm=(document.getElementById('all-months')&&document.getElementById('all-months').checked)?'':(document.getElementById('month')&&document.getElementById('month').value)||'';const md=(document.getElementById('mode-filter')&&document.getElementById('mode-filter').value)||'';const st=(document.getElementById('status-filter')&&document.getElementById('status-filter').value)||'';const df=(document.getElementById('date-from')&&document.getElementById('date-from').value)||'';const dt=(document.getElementById('date-to')&&document.getElementById('date-to').value)||'';const q=(document.getElementById('search')&&document.getElementById('search').value)||'';const data=await loadOrdersWithPayload(mm,md,st,df,dt,q);renderTable(data.items||[]);}
async function deleteOrder(id){if(!confirm('Remover este pedido do histórico?'))return;try{await __adminEnsureDb();const stmt=db.prepare("DELETE FROM orders WHERE id=?");stmt.run([id]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));}catch(e){}const mm=(document.getElementById('all-months')&&document.getElementById('all-months').checked)?'':(document.getElementById('month')&&document.getElementById('month').value)||'';const md=(document.getElementById('mode-filter')&&document.getElementById('mode-filter').value)||'';const st=(document.getElementById('status-filter')&&document.getElementById('status-filter').value)||'';const df=(document.getElementById('date-from')&&document.getElementById('date-from').value)||'';const dt=(document.getElementById('date-to')&&document.getElementById('date-to').value)||'';const q=(document.getElementById('search')&&document.getElementById('search').value)||'';const data=await loadOrdersWithPayload(mm,md,st,df,dt,q);renderTable(data.items||[]);}
async function savePhone(id,phone){try{await __adminEnsureDb();const stmt=db.prepare("UPDATE orders SET phone=? WHERE id=?");stmt.run([phone,id]);stmt.free();localStorage.setItem('bella2_db',toB64(db.export()));}catch(e){}}
function buildWhatsAppMessage(payload){let obj={};try{obj=JSON.parse(payload||'{}');}catch{obj={};}const pizzas=obj.pizzas||[];const beverages=obj.beverages||[];let lines=['Resumo do Pedido','--- PIZZAS ---'];for(let i=0;i<pizzas.length;i++){const p=pizzas[i];const line='Pizza '+(i+1)+' — Tamanho: '+(p.size||'')+' — Sabores: '+(Array.isArray(p.flavors)?p.flavors.join(' + '):'')+' — Preço: R$ '+Number(p.price||0).toFixed(2).replace('.',',');if(p.note)lines.push(line+' — Obs: '+p.note);else lines.push(line);}lines.push('','--- REFRIGERANTES ---');if(beverages.length){let counts={};for(let i=0;i<beverages.length;i++){const t=beverages[i].type||'';counts[t]=(counts[t]||0)+1;}const names=Object.keys(counts);for(let i=0;i<names.length;i++){lines.push('- '+names[i]+' x '+counts[names[i]]);} } else {lines.push('Nenhum');}lines.push('');lines.push('--- TOTAL ---');lines.push('R$ '+Number(obj.total||0).toFixed(2).replace('.',','));return lines.map(function (line){return encodeURIComponent(line);}).join('%0A');}
function resendWhatsApp(id){const payload=ordersPayloadMap[id]||'';const message=buildWhatsAppMessage(payload);const url='https://wa.me/5512996829155?text='+message;window.open(url,'_blank');}
function downloadBackup(){const data=localStorage.getItem('bella2_db')||'';const blob=new Blob([data],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='bella2_db_backup.txt';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
async function restoreBackup(file){const reader=new FileReader();reader.onload=async function(){const text=String(reader.result||'').trim();try{await __adminEnsureDb();const testDb=new SQLModule.Database(fromB64(text));if(testDb){localStorage.setItem('bella2_db',text);db=new SQLModule.Database(fromB64(text));alert('Backup restaurado com sucesso.');}else{alert('Arquivo inválido.');}}catch(e){alert('Falha ao restaurar: arquivo inválido.');}};reader.readAsText(file);}
function renderRevenueChartBars(monthTotals){const container=document.getElementById('revenue-chart');if(!container)return;const months=Object.keys(monthTotals).sort();if(months.length===0){container.innerHTML='';return;}const max=Math.max.apply(null,months.map(m=>monthTotals[m]||0));let bars='<div style="display:flex;gap:8px;align-items:flex-end;height:180px;padding:10px 0;">';for(let i=0;i<months.length;i++){const m=months[i];const val=monthTotals[m]||0;const h=max>0?Math.round((val/max)*160):0;bars+='<div title="'+m+' '+fmtBRL(val)+'" style="width:28px;background:#ffc107;border:1px solid #333;height:'+h+'px"></div>'; }bars+='</div>';let labels='<div style="display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap;">';for(let i=0;i<months.length;i++){labels+='<div style="width:28px;text-align:center;font-size:12px;color:#ccc">'+months[i]+'</div>';}labels+='</div>';container.innerHTML='<h4 style="margin:6px 0;color:#ffc107">Faturamento mensal (concluídos)</h4>'+bars+labels;}
async function renderRevenueChartAll(){const data=await loadOrdersWithPayload('', '', 'completed');const items=data.items||[];const totals={};for(let i=0;i<items.length;i++){const o=items[i];const base=o.settled_at||o.created_at||'';const key=typeof base==='string'?base.slice(0,7):'';if(!key)continue;totals[key]=(totals[key]||0)+Number(o.total||0);}renderRevenueChartBars(totals);}
document.addEventListener('DOMContentLoaded',async function(){if(__adminEnhanceApplied)return;__adminEnhanceApplied=true;const monthEl=document.getElementById('month');const modeEl=document.getElementById('mode-filter');const statusEl=document.getElementById('status-filter');const allMonthsEl=document.getElementById('all-months');async function refreshEnhanced(){const mm=(allMonthsEl&&allMonthsEl.checked)?'':((monthEl&&monthEl.value)||'');const md=(modeEl&&modeEl.value)||'';const st=(statusEl&&statusEl.value)||'';const df=(document.getElementById('date-from')&&document.getElementById('date-from').value)||'';const dt=(document.getElementById('date-to')&&document.getElementById('date-to').value)||'';const q=(document.getElementById('search')&&document.getElementById('search').value)||'';const data=await loadOrdersWithPayload(mm,md,st,df,dt,q);renderTable(data.items||[]);await renderRevenueChartAll();}if(allMonthsEl)allMonthsEl.addEventListener('change',refreshEnhanced);if(monthEl)monthEl.addEventListener('change',refreshEnhanced);if(modeEl)modeEl.addEventListener('change',refreshEnhanced);if(statusEl)statusEl.addEventListener('change',refreshEnhanced);const sEl=document.getElementById('search');if(sEl)sEl.addEventListener('input',refreshEnhanced);const dfEl=document.getElementById('date-from');const dtEl=document.getElementById('date-to');if(dfEl)dfEl.addEventListener('change',refreshEnhanced);if(dtEl)dtEl.addEventListener('change',refreshEnhanced);await ensureOrderStatusColumns();await refreshEnhanced();const dl=document.getElementById('backup-download');if(dl)dl.addEventListener('click',downloadBackup);const up=document.getElementById('backup-upload');if(up)up.addEventListener('change',function(e){const f=e.target.files&&e.target.files[0];if(f)restoreBackup(f);});});
</script>
</body>
</html>
